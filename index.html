<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapisy na Treningi Siatkówki</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SHEET_ID = '1fGvXRbfYBNpul-jC3YFN2mFx39KLEusZMZCkTOeJH7s';

        // Ikony SVG
        const Calendar = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Users = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Check = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const VolleyballApp = () => {
            const [trainings, setTrainings] = useState([]);
            const [subscriptions, setSubscriptions] = useState([]);
            const [bookings, setBookings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('bookings');

            // Funkcje do odczytu danych z Google Sheets
            const fetchSheetData = async (sheetName) => {
                try {
                    const response = await fetch(
                        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`
                    );
                    const text = await response.text();
                    const json = JSON.parse(text.substring(47).slice(0, -2));
                    return json.table.rows.map(row => 
                        row.c ? row.c.map(cell => cell ? cell.v : '') : []
                    );
                } catch (err) {
                    console.error(`Błąd odczytu ${sheetName}:`, err);
                    return [];
                }
            };

            const loadData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const [trainingsData, subscriptionsData, bookingsData] = await Promise.all([
                        fetchSheetData('Treningi'),
                        fetchSheetData('Abonamenty'),
                        fetchSheetData('Zapisy')
                    ]);

                    // Pomiń pierwszy wiersz (nagłówki) i puste wiersze
                    setTrainings(trainingsData.slice(1).filter(row => row[0]));
                    setSubscriptions(subscriptionsData.slice(1).filter(row => row[0]));
                    setBookings(bookingsData.slice(1).filter(row => row[0]));
                } catch (err) {
                    setError('Nie udało się załadować danych. Sprawdź połączenie.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadData();
                // Odświeżaj dane co 30 sekund
                const interval = setInterval(loadData, 30000);
                return () => clearInterval(interval);
            }, []);

            // Funkcja sprawdzająca czy osoba ma abonament
            const hasSubscription = (name) => {
                return subscriptions.some(sub => sub[0] === name);
            };

            // Funkcja formatująca datę
            const formatDate = (dateValue) => {
                if (!dateValue) return '';
                // Google Sheets zwraca daty jako "Date(2024,11,5,0,0,0)"
                if (typeof dateValue === 'string' && dateValue.startsWith('Date(')) {
                    const match = dateValue.match(/Date\((\d+),(\d+),(\d+)/);
                    if (match) {
                        const year = match[1];
                        const month = String(parseInt(match[2]) + 1).padStart(2, '0');
                        const day = String(match[3]).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                }
                return dateValue;
            };

            // Funkcja formatująca godzinę
            const formatTime = (timeValue) => {
                if (!timeValue) return '';
                // Google Sheets zwraca czas jako liczbę dziesiętną (np. 0.75 = 18:00)
                if (typeof timeValue === 'number') {
                    const hours = Math.floor(timeValue * 24);
                    const minutes = Math.floor((timeValue * 24 - hours) * 60);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                return timeValue;
            };

            // Grupowanie zapisów według treningów
            const getBookingsByTraining = () => {
                const grouped = {};
                
                trainings.forEach(training => {
                    const date = formatDate(training[0]);
                    const time = formatTime(training[1]);
                    const limit = parseInt(training[2]) || 12;
                    const key = `${date} ${time}`;
                    
                    grouped[key] = {
                        date,
                        time,
                        limit,
                        participants: []
                    };
                });

                bookings.forEach(booking => {
                    const termin = booking[0];
                    const name = booking[1];
                    
                    if (grouped[termin]) {
                        grouped[termin].participants.push({
                            name,
                            hasSubscription: hasSubscription(name),
                            timestamp: booking[2] || Date.now()
                        });
                    }
                });

                // Sortuj uczestników: najpierw z abonamentem, potem chronologicznie
                Object.keys(grouped).forEach(key => {
                    grouped[key].participants.sort((a, b) => {
                        if (a.hasSubscription === b.hasSubscription) {
                            return a.timestamp - b.timestamp;
                        }
                        return b.hasSubscription ? 1 : -1;
                    });
                });

                return grouped;
            };

            const groupedBookings = getBookingsByTraining();

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-50 flex items-center justify-center">
                        <div className="text-center">
                            <RefreshCw className="animate-spin mx-auto mb-4 text-orange-500" size={48} />
                            <p className="text-gray-600">Ładowanie danych...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-3">
                                    <div className="bg-orange-500 p-3 rounded-lg">
                                        <Calendar size={28} className="text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-800">Zapisy na Treningi</h1>
                                        <p className="text-gray-600">System zapisów na siatkówkę</p>
                                    </div>
                                </div>
                                <button
                                    onClick={loadData}
                                    className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-2"
                                >
                                    <RefreshCw size={20} />
                                    Odśwież
                                </button>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-center gap-3">
                                    <AlertCircle className="text-red-500" size={24} />
                                    <p className="text-red-700">{error}</p>
                                </div>
                            )}

                            <div className="flex gap-2 mb-6 flex-wrap">
                                <button
                                    onClick={() => setActiveTab('bookings')}
                                    className={`px-4 py-2 rounded-lg transition ${
                                        activeTab === 'bookings'
                                            ? 'bg-orange-500 text-white'
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Zapisy
                                </button>
                                <button
                                    onClick={() => setActiveTab('trainings')}
                                    className={`px-4 py-2 rounded-lg transition ${
                                        activeTab === 'trainings'
                                            ? 'bg-orange-500 text-white'
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Treningi ({trainings.length})
                                </button>
                                <button
                                    onClick={() => setActiveTab('subscriptions')}
                                    className={`px-4 py-2 rounded-lg transition ${
                                        activeTab === 'subscriptions'
                                            ? 'bg-orange-500 text-white'
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Abonamenty ({subscriptions.length})
                                </button>
                            </div>

                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p className="text-blue-800 text-sm">
                                    <strong>Aby edytować dane:</strong> Otwórz arkusz Google Sheets i dodaj/edytuj wiersze bezpośrednio tam. 
                                    Kliknij "Odśwież" aby zobaczyć najnowsze zmiany.
                                </p>
                                <a 
                                    href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-blue-600 hover:text-blue-700 underline text-sm mt-2 inline-block"
                                >
                                    Otwórz Google Sheets →
                                </a>
                            </div>
                        </div>

                        {activeTab === 'bookings' && (
                            <div className="grid gap-6">
                                {Object.keys(groupedBookings).length === 0 ? (
                                    <div className="bg-white rounded-xl shadow-lg p-12 text-center">
                                        <Calendar size={48} className="mx-auto mb-4 text-gray-400" />
                                        <p className="text-gray-500 text-lg">Brak zaplanowanych treningów</p>
                                        <p className="text-gray-400 mt-2">Dodaj treningi w arkuszu Google Sheets</p>
                                    </div>
                                ) : (
                                    Object.entries(groupedBookings).map(([key, training]) => {
                                        const acceptedCount = training.participants.filter((_, i) => i < training.limit).length;
                                        const waitingCount = training.participants.length - acceptedCount;

                                        return (
                                            <div key={key} className="bg-white rounded-xl shadow-lg overflow-hidden">
                                                <div className="bg-gradient-to-r from-orange-500 to-blue-500 p-4 text-white">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h2 className="text-xl font-bold">
                                                                {training.date} o {training.time}
                                                            </h2>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-4 mt-3 text-sm flex-wrap">
                                                        <div className="flex items-center gap-2">
                                                            <Users size={18} />
                                                            <span>Limit: {training.limit} osób</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <Check size={18} />
                                                            <span>Zapisanych: {acceptedCount}/{training.limit}</span>
                                                        </div>
                                                        {waitingCount > 0 && (
                                                            <div className="flex items-center gap-2">
                                                                <span>Lista rezerwowa: {waitingCount}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="p-6">
                                                    {training.participants.length === 0 ? (
                                                        <p className="text-gray-400 text-center py-4">Brak zapisanych uczestników</p>
                                                    ) : (
                                                        <div className="space-y-2">
                                                            {training.participants.map((participant, index) => {
                                                                const status = index < training.limit ? 'accepted' : 'waiting';
                                                                return (
                                                                    <div
                                                                        key={index}
                                                                        className={`flex items-center justify-between p-3 rounded-lg ${
                                                                            status === 'accepted'
                                                                                ? 'bg-green-50 border border-green-200'
                                                                                : 'bg-yellow-50 border border-yellow-200'
                                                                        }`}
                                                                    >
                                                                        <div className="flex items-center gap-3 flex-wrap">
                                                                            <span className="font-semibold text-gray-600">
                                                                                {index + 1}.
                                                                            </span>
                                                                            <span className="font-medium text-gray-800">
                                                                                {participant.name}
                                                                            </span>
                                                                            {participant.hasSubscription && (
                                                                                <span className="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-medium">
                                                                                    ABONAMENT
                                                                                </span>
                                                                            )}
                                                                            {status === 'waiting' && (
                                                                                <span className="bg-yellow-500 text-white text-xs px-2 py-1 rounded-full font-medium">
                                                                                    LISTA REZERWOWA
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === 'trainings' && (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-bold mb-4">Lista Treningów</h2>
                                {trainings.length === 0 ? (
                                    <p className="text-gray-400 text-center py-8">Brak treningów w systemie</p>
                                ) : (
                                    <div className="space-y-2">
                                        {trainings.map((training, index) => (
                                            <div key={index} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg flex-wrap">
                                                <span className="font-semibold text-gray-600">{index + 1}.</span>
                                                <span className="font-medium">{formatDate(training[0])}</span>
                                                <span className="text-gray-600">{formatTime(training[1])}</span>
                                                <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                                                    Limit: {training[2]}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'subscriptions' && (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-bold mb-4">Lista Abonamentów</h2>
                                {subscriptions.length === 0 ? (
                                    <p className="text-gray-400 text-center py-8">Brak abonamentów w systemie</p>
                                ) : (
                                    <div className="space-y-2">
                                        {subscriptions.map((sub, index) => (
                                            <div key={index} className="flex items-center gap-4 p-3 bg-orange-50 rounded-lg flex-wrap">
                                                <span className="font-semibold text-gray-600">{index + 1}.</span>
                                                <span className="font-medium flex-1">{sub[0]}</span>
                                                <span className="text-gray-600 text-sm">
                                                    {formatDate(sub[1])} - {formatDate(sub[2])}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<VolleyballApp />, document.getElementById('root'));
    </script>
</body>
</html>
